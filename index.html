<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StellaTouch</title>
    <style>
        :root { --accent: #007bff; --bg: #121212; --panel: rgba(30, 30, 30, 0.98); --text: #ffffff; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: sans-serif; touch-action: none; user-select: none; }
        
        #viewport { position: fixed; inset: 0; overflow: hidden; background: #222; display: flex; align-items: center; justify-content: center; }
        #canvas-wrapper { position: relative; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); transform-origin: center; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #interaction-layer { pointer-events: auto !important; z-index: 100; cursor: crosshair; }

        /* UIéƒ¨ */
        #bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: var(--panel); display: flex; align-items: center; justify-content: space-around; padding: 0 10px; z-index: 1000; border-top: 1px solid #333; }
        .m-btn { width: 55px; height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 20px; border-radius: 12px; border: none; background: transparent; color: white; cursor: pointer; }
        .m-btn.active { background: var(--accent); }
        .m-btn span { font-size: 9px; margin-top: 4px; }

        #top-bar { position: fixed; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .btn-group { display: flex; gap: 8px; pointer-events: auto; }
        .circle-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--panel); border: 1px solid #444; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
        #side-panel { position: fixed; top: 0; right: -320px; bottom: 75px; width: 300px; background: var(--panel); transition: 0.3s; z-index: 1001; padding: 15px; border-radius: 20px 0 0 20px; border-left: 1px solid #444; overflow-y: auto; }
        #side-panel.open { right: 0; }
        
        .layer-item { background: #2a2a2a; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 2px solid transparent; }
        .layer-item.active { border-color: var(--accent); background: #333; }
        .layer-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .layer-name { flex-grow: 1; font-size: 14px; cursor: pointer; }
        .layer-controls { display: flex; gap: 4px; }
        .l-btn { background: #444; border: none; color: white; padding: 5px; border-radius: 4px; font-size: 12px; cursor: pointer; width: 28px; }
        
        .layer-settings { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
        .select-style { background: #444; color: white; border: none; border-radius: 4px; font-size: 11px; padding: 4px; }
        .opacity-box { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #aaa; margin-top: 8px; }
        .opacity-slider { flex-grow: 1; height: 4px; accent-color: var(--accent); }

        #setup-screen { position: fixed; inset: 0; background: #111; z-index: 3000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="setup-screen">
    <div style="background:#222; padding:30px; border-radius:20px; text-align:center;">
        <h2 style="color:var(--accent)">StellaTouch</h2>
        <input type="number" id="inputW" value="1000"> Ã— <input type="number" id="inputH" value="1200">
        <br><br>
        <button onclick="initApp()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:bold;">ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ</button>
    </div>
</div>

<div id="viewport">
    <div id="canvas-wrapper">
        <canvas id="interaction-layer"></canvas>
    </div>
</div>

<div id="top-bar">
    <div class="btn-group">
        <button class="circle-btn" onclick="undo()" title="Undo (Ctrl+Z)">â†©ï¸</button>
        <button class="circle-btn" onclick="redo()" title="Redo (Ctrl+Y)">â†ªï¸</button>
        <button class="circle-btn" onclick="toggleFlip()" title="å·¦å³åè»¢">â†”ï¸</button>
    </div>
    <div class="btn-group">
        <button class="circle-btn" onclick="changeZoom(1.2)">ğŸ”+</button>
        <button class="circle-btn" onclick="changeZoom(0.8)">ğŸ”-</button>
        <button class="circle-btn" onclick="resetZoom()">å›</button>
        <button class="circle-btn" onclick="document.getElementById('imgIn').click()">ğŸ–¼ï¸</button>
        <button class="circle-btn" onclick="saveImage()">ğŸ’¾</button>
        <input type="file" id="imgIn" hidden accept="image/*" onchange="handleImport(this)">
    </div>
</div>

<div id="bottom-bar">
    <button class="m-btn active" id="btn-brush" onclick="setTool('brush')">ğŸ–Œï¸<span>ãƒšãƒ³(B)</span></button>
    <button class="m-btn" id="btn-eraser" onclick="setTool('eraser')">ğŸ§½<span>æ¶ˆã—(E)</span></button>
    <button class="m-btn" id="btn-fill" onclick="setTool('fill')">ğŸ«—<span>å¡—ã‚‹(G)</span></button>
    <button class="m-btn" id="btn-pan" onclick="setTool('pan')">âœ‹<span>ç§»å‹•(H)</span></button>
    <button class="m-btn" onclick="togglePanel()">ğŸ“‚<span>å±¤</span></button>
</div>

<div id="side-panel">
    <h3>ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†</h3>
    <div id="layerList"></div>
    <button onclick="addLayer()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:8px; margin-top:10px;">+ ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ </button>
    <hr style="margin:20px 0; border-top:1px solid #444;">
    <div style="font-size:12px;">ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚º: <span id="size-val">20</span></div>
    <input type="range" id="size" min="1" max="200" value="20" oninput="document.getElementById('size-val').innerText=this.value" style="width:100%;">
    <input type="color" id="picker" value="#007bff" style="width:100%; height:44px; margin-top:10px;">
    <button onclick="togglePanel()" style="width:100%; margin-top:20px; padding:10px;">é–‰ã˜ã‚‹</button>
</div>

<script>
    let layers = [], curIdx = -1, canvasW, canvasH;
    let scale = 1, offsetX = 0, offsetY = 0;
    let drawing = false, panning = false, currentTool = 'brush';
    let lastX, lastY, undoStack = [], redoStack = [];
    let isSpaceDown = false;
    let isFlipped = false; // å·¦å³åè»¢çŠ¶æ…‹
    let stabilizerAmount = 0.5; // æ‰‹ãƒ–ãƒ¬è£œæ­£ã®å¼·ã• (0ã€œ1)
    let lastPoints = []; // æ‰‹ãƒ–ãƒ¬è£œæ­£ç”¨ã®åº§æ¨™å±¥æ­´
    let longPressTimer; // ã‚¹ãƒã‚¤ãƒˆç”¨ã®ã‚¿ã‚¤ãƒãƒ¼

    const wrapper = document.getElementById('canvas-wrapper');
    const inter = document.getElementById('interaction-layer');

    function initApp() {
        canvasW = parseInt(document.getElementById('inputW').value) || 1000;
        canvasH = parseInt(document.getElementById('inputH').value) || 1200;
        document.getElementById('setup-screen').style.display = 'none';
        wrapper.style.width = canvasW + 'px'; wrapper.style.height = canvasH + 'px';
        inter.width = canvasW; inter.height = canvasH;
        addLayer("èƒŒæ™¯", true);
        addLayer("ãƒ¬ã‚¤ãƒ¤ãƒ¼ 1");
        saveState();
        resetZoom();
        setupEvents();
    }

    function setupEvents() {
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        window.addEventListener('keydown', e => {
            if(e.code === 'Space') { isSpaceDown = true; inter.style.cursor = 'grab'; }
            if(e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
            if(e.ctrlKey && (e.key === 'y' || e.key === 'Z')) { e.preventDefault(); redo(); }
            if(e.key === 'b') setTool('brush');
            if(e.key === 'e') setTool('eraser');
            if(e.key === 'g') setTool('fill');
            if(e.key === 'h') setTool('pan');
            if(e.key === '[') updateSize(-5);
            if(e.key === ']') updateSize(5);
        });
        window.addEventListener('keyup', e => { if(e.code === 'Space') { isSpaceDown = false; inter.style.cursor = 'crosshair'; } });

        window.addEventListener('wheel', e => { if(e.ctrlKey || e.target.closest('#viewport')) { e.preventDefault(); changeZoom(e.deltaY > 0 ? 0.9 : 1.1); } }, {passive: false});
        
        // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ (ç­†åœ§å¯¾å¿œ)
        // --- setupEventså†…ã® pointerdown ã‚’æ›¸ãæ›ãˆ ---
inter.addEventListener('pointerdown', e => {
    if(isSpaceDown || currentTool === 'pan' || e.button === 1) { panning = true; return; }
    
    // ã‚¹ãƒã‚¤ãƒˆç”¨ã®é•·æŠ¼ã—ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ (500ms)
    const pos = getPos(e);
    longPressTimer = setTimeout(() => {
        if (!panning && drawing) {
            pickColor(Math.round(pos.x), Math.round(pos.y));
            drawing = false; // æç”»ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚¹ãƒã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã¸
            inter.releasePointerCapture(e.pointerId);
        }
    }, 500);

    drawing = true;
    lastPoints = []; // æ‰‹ãƒ–ãƒ¬è£œæ­£å±¥æ­´ãƒªã‚»ãƒƒãƒˆ
    const sPos = getStabilizedPos(pos);
    if(currentTool === 'fill') { floodFill(Math.round(sPos.x), Math.round(sPos.y)); saveState(); drawing = false; }
    lastX = sPos.x; lastY = sPos.y;
    inter.setPointerCapture(e.pointerId);
});

// --- setupEventså†…ã® pointermove ã‚’æ›¸ãæ›ãˆ ---
        window.addEventListener('pointermove', e => {
            if(panning) { offsetX += e.movementX; offsetY += e.movementY; updateTransform(); return; }
            if(!drawing || curIdx === -1) return;

    // å‹•ã„ãŸã‚‰é•·æŠ¼ã—ã‚¹ãƒã‚¤ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            clearTimeout(longPressTimer);

            const pos = getPos(e);
            const sPos = getStabilizedPos(pos); // æ‰‹ãƒ–ãƒ¬è£œæ­£ã‚’é©ç”¨
            const ctx = layers[curIdx].ctx;
    
            const pressure = e.pressure > 0 ? e.pressure : 1;
            const baseSize = document.getElementById('size').value;
    
            ctx.save();
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.lineWidth = baseSize * pressure;
            ctx.strokeStyle = document.getElementById('picker').value;
            if(currentTool === 'eraser') ctx.globalCompositeOperation = 'destination-out';
    
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(sPos.x, sPos.y);
            ctx.stroke();
            ctx.restore();
            lastX = sPos.x; lastY = sPos.y;
        });

// --- pointerup ã«ã‚¿ã‚¤ãƒãƒ¼è§£é™¤ã‚’è¿½åŠ  ---
        window.addEventListener('pointerup', () => { 
            clearTimeout(longPressTimer); // ã‚¹ãƒã‚¤ãƒˆè§£é™¤
            if(drawing) saveState(); 
            drawing = false; 
            panning = false; 
        });

        window.addEventListener('pointermove', e => {
            if(panning) { offsetX += e.movementX; offsetY += e.movementY; updateTransform(); return; }
            if(!drawing || curIdx === -1) return;
            const pos = getPos(e);
            const ctx = layers[curIdx].ctx;
            
            // ç­†åœ§ã®é©ç”¨ (ãƒã‚¦ã‚¹ãªã©ã¯ 0.5 å›ºå®šã€ãƒšãƒ³ã¯ 0ï½1.0)
            const pressure = e.pressure > 0 ? e.pressure : 1;
            const baseSize = document.getElementById('size').value;
            
            ctx.save();
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.lineWidth = baseSize * pressure; // ç­†åœ§ã§å¤ªã•ã‚’å¤‰ãˆã‚‹
            ctx.strokeStyle = document.getElementById('picker').value;
            if(currentTool === 'eraser') ctx.globalCompositeOperation = 'destination-out';
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            ctx.restore();
            
            lastX = pos.x; lastY = pos.y;
        });

        window.addEventListener('pointerup', () => { if(drawing) saveState(); drawing = false; panning = false; });
    }

    function getPos(e) {
        const rect = wrapper.getBoundingClientRect();
        return { x: (e.clientX - rect.left) / scale, y: (e.clientY - rect.top) / scale };
    }

    function updateSize(delta) {
        const input = document.getElementById('size');
        input.value = Math.max(1, Math.min(200, parseInt(input.value) + delta));
        document.getElementById('size-val').innerText = input.value;
    }

    function addLayer(name = null, white = false) {
        const canvas = document.createElement('canvas');
        canvas.width = canvasW; canvas.height = canvasH;
        const ctx = canvas.getContext('2d', {willReadFrequently: true});
        if(white) { ctx.fillStyle = "white"; ctx.fillRect(0,0,canvasW,canvasH); }
        layers.push({ canvas, ctx, name: name || `ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${layers.length+1}`, opacity: 1, blend: 'normal' });
        wrapper.insertBefore(canvas, inter);
        curIdx = layers.length - 1;
        renderLayerList();
    }

    function updateBlend(idx, mode) { layers[idx].blend = mode; layers[idx].canvas.style.mixBlendMode = mode; }
    function updateOpacity(idx, val) { layers[idx].opacity = val; layers[idx].canvas.style.opacity = val; }
    
    function moveLayer(idx, dir, e) {
        e.stopPropagation();
        const target = idx + dir;
        if(target < 0 || target >= layers.length) return;
        [layers[idx], layers[target]] = [layers[target], layers[idx]];
        layers.forEach(l => wrapper.appendChild(l.canvas));
        wrapper.appendChild(inter);
        curIdx = target;
        renderLayerList();
    }

    function deleteLayer(idx, e) {
        e.stopPropagation();
        if(layers.length <= 1) return;
        wrapper.removeChild(layers[idx].canvas);
        layers.splice(idx, 1);
        curIdx = Math.max(0, idx - 1);
        renderLayerList();
        saveState();
    }

    function renderLayerList() {
        const list = document.getElementById('layerList');
        list.innerHTML = '';
        layers.forEach((l, i) => {
            const d = document.createElement('div');
            d.className = `layer-item ${i === curIdx ? 'active' : ''}`;
            d.onclick = () => { curIdx = i; renderLayerList(); };
            d.innerHTML = `
                <div class="layer-row"><span class="layer-name" onclick="renameLayer(${i}, event)">${l.name}</span>
                <div class="layer-controls"><button class="l-btn" onclick="moveLayer(${i}, 1, event)">â–²</button>
                <button class="l-btn" onclick="moveLayer(${i}, -1, event)">â–¼</button>
                <button class="l-btn" onclick="deleteLayer(${i}, event)">ğŸ—‘ï¸</button></div></div>
                <div class="layer-settings"><select class="select-style" onchange="updateBlend(${i}, this.value)" onclick="event.stopPropagation()">
                <option value="normal" ${l.blend==='normal'?'selected':''}>é€šå¸¸</option>
                <option value="multiply" ${l.blend==='multiply'?'selected':''}>ä¹—ç®—</option>
                <option value="screen" ${l.blend==='screen'?'selected':''}>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³</option>
                <option value="overlay" ${l.blend==='overlay'?'selected':''}>ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</option></select>
                <div class="opacity-box"><input type="range" class="opacity-slider" min="0" max="1" step="0.01" value="${l.opacity}" oninput="updateOpacity(${i}, this.value)" onclick="event.stopPropagation()"></div></div>`;
            list.prepend(d);
        });
    }

    function renameLayer(idx, e) { e.stopPropagation(); const n = prompt("åå‰:", layers[idx].name); if(n) { layers[idx].name = n; renderLayerList(); } }
    function setTool(t) { currentTool = t; document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active')); document.getElementById(`btn-${t}`).classList.add('active'); }
    function togglePanel() { document.getElementById('side-panel').classList.toggle('open'); }
    function changeZoom(f) { scale = Math.min(Math.max(scale * f, 0.1), 10); updateTransform(); }
    function updateTransform() { wrapper.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`; }
    function resetZoom() { const v = document.getElementById('viewport'); scale = Math.min(v.clientWidth / canvasW, v.clientHeight / canvasH) * 0.85; offsetX = 0; offsetY = 0; updateTransform(); }

    function saveState() {
        undoStack.push(layers.map(l => ({ img: l.canvas.toDataURL(), name: l.name, op: l.opacity, bl: l.blend })));
        if(undoStack.length > 50) undoStack.shift();
        redoStack = [];
    }

    function undo() { if(undoStack.length <= 1) return; redoStack.push(undoStack.pop()); applyState(undoStack[undoStack.length-1]); }
    function redo() { if(!redoStack.length) return; const s = redoStack.pop(); undoStack.push(s); applyState(s); }
    function applyState(state) {
        state.forEach((data, i) => {
            const img = new Image();
            img.onload = () => { layers[i].ctx.clearRect(0,0,canvasW,canvasH); layers[i].ctx.drawImage(img,0,0); layers[i].name = data.name; updateOpacity(i, data.op); updateBlend(i, data.bl); renderLayerList(); };
            img.src = data.img;
        });
    }

    function handleImport(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                addLayer("ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”»åƒ");
                const ctx = layers[curIdx].ctx;
                const ratio = Math.min(canvasW / img.width, canvasH / img.height);
                ctx.drawImage(img, 0, 0, img.width * ratio, img.height * ratio);
                saveState();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function floodFill(startX, startY) {
        const ctx = layers[curIdx].ctx; const id = ctx.getImageData(0,0,canvasW,canvasH); const d = id.data;
        const p = (startY * canvasW + startX) * 4; const tr = d[p], tg = d[p+1], tb = d[p+2], ta = d[p+3];
        const fc = document.getElementById('picker').value;
        const f = {r:parseInt(fc.slice(1,3),16), g:parseInt(fc.slice(3,5),16), b:parseInt(fc.slice(5,7),16)};
        if(tr===f.r && tg===f.g && tb===f.b && ta===255) return;
        const s = [[startX, startY]];
        while(s.length) {
            const [x,y] = s.pop(); const curP = (y * canvasW + x) * 4;
            if(x>=0 && x<canvasW && y>=0 && y<canvasH && d[curP]===tr && d[curP+1]===tg && d[curP+2]===tb && d[curP+3]===ta) {
                d[curP]=f.r; d[curP+1]=f.g; d[curP+2]=f.b; d[curP+3]=255;
                s.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
            }
        }
        ctx.putImageData(id,0,0);
    }

    function saveImage() {
        const out = document.createElement('canvas'); out.width = canvasW; out.height = canvasH;
        const octx = out.getContext('2d');
        layers.forEach(l => { octx.save(); octx.globalAlpha = l.opacity; octx.globalCompositeOperation = l.blend === 'normal' ? 'source-over' : l.blend; octx.drawImage(l.canvas, 0, 0); octx.restore(); });
        const a = document.createElement('a'); a.download = 'art_pro.png'; a.href = out.toDataURL(); a.click();
    }
    // --- å·¦å³åè»¢æ©Ÿèƒ½ ---
function toggleFlip() {
    isFlipped = !isFlipped;
    wrapper.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${isFlipped ? -scale : scale}, ${scale})`;
}

// --- æ‰‹ãƒ–ãƒ¬è£œæ­£ï¼ˆæŒ‡æ•°å¹³æ»‘æ³•ï¼‰ ---
function getStabilizedPos(pos) {
    if (lastPoints.length === 0) {
        lastPoints.push(pos);
        return pos;
    }
    const last = lastPoints[lastPoints.length - 1];
    // æ–°ã—ã„åº§æ¨™ = å‰å›ã®åº§æ¨™ + (ä»Šå›ã®åº§æ¨™ - å‰å›ã®åº§æ¨™) * (1 - è£œæ­£å¼·åº¦)
    const smoothed = {
        x: last.x + (pos.x - last.x) * (1 - stabilizerAmount),
        y: last.y + (pos.y - last.y) * (1 - stabilizerAmount)
    };
    lastPoints.push(smoothed);
    if (lastPoints.length > 5) lastPoints.shift();
    return smoothed;
}

// --- ã‚¹ãƒã‚¤ãƒˆæ©Ÿèƒ½ï¼ˆç‰¹å®šåº§æ¨™ã®è‰²ã‚’å–å¾—ï¼‰ ---
function pickColor(x, y) {
    // å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åˆæˆã—ãŸè‰²ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€ä¸€æ™‚çš„ãªã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã‹
    // ã¾ãŸã¯ç¾åœ¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰å–å¾—ï¼ˆæŒ‡æãã§ã¯ç¾åœ¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰å–ã‚‹ã®ãŒä¸€èˆ¬çš„ï¼‰
    const ctx = layers[curIdx].ctx;
    const pixel = ctx.getImageData(x, y, 1, 1).data;
    if (pixel[3] === 0) return; // é€æ˜ç®‡æ‰€ã¯ç„¡è¦–
    const hex = "#" + ((1 << 24) + (pixel[0] << 16) + (pixel[1] << 8) + pixel[2]).toString(16).slice(1);
    document.getElementById('picker').value = hex;
}
</script>
</body>
</html>
