<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StellaTouch</title>
    <style>
        :root { --accent: #007bff; --bg: #121212; --panel: rgba(30, 30, 30, 0.98); --text: #ffffff; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: sans-serif; touch-action: none; user-select: none; }
        
        #viewport { position: fixed; inset: 0; overflow: hidden; background: #222; display: flex; align-items: center; justify-content: center; }
        #canvas-wrapper { position: relative; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); transform-origin: center; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #interaction-layer { pointer-events: auto !important; z-index: 100; cursor: crosshair; }

        /* ÁîªÂÉèÂ§âÂΩ¢UI */
        #transform-ui { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: var(--accent); padding: 10px 20px; border-radius: 30px; z-index: 2000; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }

        /* „É°„Ç§„É≥„ÉÑ„Éº„É´„Éê„ÉºÔºà‰∏ãÈÉ®Ôºâ */
        #bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: var(--panel); display: flex; align-items: center; justify-content: space-around; padding: 0 10px; z-index: 1000; border-top: 1px solid #333; }
        .m-btn { width: 55px; height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 20px; border-radius: 12px; border: none; background: transparent; color: white; cursor: pointer; }
        .m-btn.active { background: var(--accent); }
        .m-btn span { font-size: 9px; margin-top: 4px; }

        /* ‰∏äÈÉ®„Çµ„Éñ„ÉÑ„Éº„É´ */
        #top-bar { position: fixed; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .btn-group { display: flex; gap: 10px; pointer-events: auto; }
        .circle-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--panel); border: 1px solid #444; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* „Çµ„Ç§„Éâ„Éë„Éç„É´Ôºà„É¨„Ç§„É§„ÉºÔºâ */
        #side-panel { position: fixed; top: 0; right: -300px; bottom: 75px; width: 280px; background: var(--panel); transition: 0.3s; z-index: 1001; padding: 20px; border-radius: 20px 0 0 20px; border-left: 1px solid #444; overflow-y: auto; }
        #side-panel.open { right: 0; }
        
        .layer-item { background: #2a2a2a; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border: 2px solid transparent; }
        .layer-item.active { border-color: var(--accent); }
        .layer-name { flex-grow: 1; font-size: 13px; overflow: hidden; }
        .layer-btn { background: #444; border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; }

        #setup-screen { position: fixed; inset: 0; background: #111; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="setup-screen">
    <div style="background:#222; padding:30px; border-radius:20px; text-align:center;">
        <h3>„Ç≠„É£„É≥„Éê„Çπ‰ΩúÊàê</h3>
        <input type="number" id="inputW" value="1200" style="width:70px; padding:8px;"> √ó 
        <input type="number" id="inputH" value="1600" style="width:70px; padding:8px;">
        <br><br>
        <button onclick="initApp()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:8px; font-weight:bold;">ÈñãÂßã„Åô„Çã</button>
    </div>
</div>

<div id="transform-ui">
    Â§âÂΩ¢‰∏≠... <button onclick="commitTransform()" style="padding:5px 15px; border-radius:15px; border:none; background:white; color:black; font-weight:bold; cursor:pointer;">Á¢∫ÂÆö</button>
</div>

<div id="viewport">
    <div id="canvas-wrapper">
        <canvas id="interaction-layer"></canvas>
    </div>
</div>

<div id="top-bar">
    <div class="btn-group">
        <button class="circle-btn" onclick="undo()">‚Ü©Ô∏è</button>
        <button class="circle-btn" onclick="redo()">‚Ü™Ô∏è</button>
    </div>
    <div class="btn-group">
        <button class="circle-btn" onclick="resetZoom()">Âõû</button>
        <button class="circle-btn" onclick="saveImage()">üíæ</button>
    </div>
</div>

<div id="bottom-bar">
    <button class="m-btn active" id="btn-brush" onclick="setTool('brush')">üñåÔ∏è<span>„Éö„É≥</span></button>
    <button class="m-btn" id="btn-eraser" onclick="setTool('eraser')">üßΩ<span>Ê∂à„Åó</span></button>
    <button class="m-btn" id="btn-fill" onclick="setTool('fill')">ü´ó<span>Â°ó„Çã</span></button>
    <button class="m-btn" onclick="document.getElementById('imgIn').click()">üñºÔ∏è<span>ÁîªÂÉè</span></button>
    <button class="m-btn" id="btn-pan" onclick="setTool('pan')">‚úã<span>ÁßªÂãï</span></button>
    <button class="m-btn" onclick="togglePanel()">üìÇ<span>Â±§</span></button>
    <input type="file" id="imgIn" hidden accept="image/*" onchange="handleImport(this)">
</div>

<div id="side-panel">
    <h3>„É¨„Ç§„É§„Éº</h3>
    <div id="layerList"></div>
    <button onclick="addLayer()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:8px; margin-top:10px;">+ Êñ∞Ë¶èËøΩÂä†</button>
    <hr style="margin:20px 0; border:0; border-top:1px solid #444;">
    <div style="font-size:12px; margin-bottom:5px;">„Éñ„É©„Ç∑„Çµ„Ç§„Ç∫</div>
    <input type="range" id="size" min="1" max="200" value="20" style="width:100%;">
    <div style="font-size:12px; margin:15px 0 5px 0;">Ëâ≤</div>
    <input type="color" id="picker" value="#007bff" style="width:100%; height:44px; border:none; background:none;">
    <br><br>
    <button onclick="togglePanel()" style="width:100%; padding:10px; background:#444; border:none; color:white; border-radius:8px;">Èñâ„Åò„Çã</button>
</div>

<script>
    let layers = [], curIdx = -1, canvasW, canvasH;
    let scale = 1, offsetX = 0, offsetY = 0;
    let drawing = false, panning = false, currentTool = 'brush';
    let lastX, lastY, undoStack = [], redoStack = [];
    let isSpaceDown = false;

    // Â§âÂΩ¢Áî®„Çπ„ÉÜ„Éº„Éà
    let editImg = null, editState = { x: 50, y: 50, w: 300, h: 300, rot: 0 };

    const wrapper = document.getElementById('canvas-wrapper');
    const inter = document.getElementById('interaction-layer');

    function initApp() {
        canvasW = parseInt(document.getElementById('inputW').value) || 1200;
        canvasH = parseInt(document.getElementById('inputH').value) || 1600;
        document.getElementById('setup-screen').style.display = 'none';
        wrapper.style.width = canvasW + 'px'; wrapper.style.height = canvasH + 'px';
        inter.width = canvasW; inter.height = canvasH;
        addLayer("ËÉåÊôØ", true);
        addLayer("„É¨„Ç§„É§„Éº 1");
        resetZoom();
        setupEvents();
    }

    function setupEvents() {
        // PC„Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
        window.addEventListener('keydown', e => { if(e.code === 'Space') isSpaceDown = true; });
        window.addEventListener('keyup', e => { if(e.code === 'Space') isSpaceDown = false; });

        // PC„Éõ„Ç§„Éº„É´„Ç∫„Éº„É†
        window.addEventListener('wheel', e => {
            if(e.ctrlKey || e.target.id === 'interaction-layer' || e.target.id === 'viewport') {
                e.preventDefault();
                scale *= (e.deltaY > 0 ? 0.9 : 1.1);
                updateTransform();
            }
        }, {passive: false});

        // „Éù„Ç§„É≥„Çø„Éº„Ç§„Éô„É≥„Éà („Éû„Ç¶„Çπ/„Çø„ÉÉ„ÉÅÂÖ±ÈÄö)
        inter.addEventListener('pointerdown', e => {
            if(isSpaceDown || currentTool === 'pan' || e.button === 1) { panning = true; return; }
            if(editImg) return;
            
            drawing = true;
            const pos = getPos(e);
            if(currentTool === 'fill') { floodFill(Math.round(pos.x), Math.round(pos.y)); saveState(); drawing = false; }
            lastX = pos.x; lastY = pos.y;
            inter.setPointerCapture(e.pointerId);
        });

        window.addEventListener('pointermove', e => {
            if(panning) {
                offsetX += e.movementX; offsetY += e.movementY;
                updateTransform();
                return;
            }
            if(!drawing || curIdx === -1) return;
            const pos = getPos(e);
            const ctx = layers[curIdx].ctx;
            ctx.save();
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.lineWidth = document.getElementById('size').value;
            ctx.strokeStyle = document.getElementById('picker').value;
            if(currentTool === 'eraser') ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke();
            ctx.restore();
            lastX = pos.x; lastY = pos.y;
        });

        window.addEventListener('pointerup', () => { if(drawing) saveState(); drawing = false; panning = false; });
    }

    function getPos(e) {
        const rect = wrapper.getBoundingClientRect();
        return { x: (e.clientX - rect.left) / scale, y: (e.clientY - rect.top) / scale };
    }

    function updateTransform() {
        wrapper.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
    }

    function resetZoom() {
        const v = document.getElementById('viewport');
        scale = Math.min(v.clientWidth / canvasW, v.clientHeight / canvasH) * 0.85;
        offsetX = 0; offsetY = 0;
        updateTransform();
    }

    // --- „É¨„Ç§„É§„ÉºÊìç‰Ωú ---
    function addLayer(name = null, white = false) {
        const canvas = document.createElement('canvas');
        canvas.width = canvasW; canvas.height = canvasH;
        const ctx = canvas.getContext('2d', {willReadFrequently: true});
        if(white) { ctx.fillStyle = "white"; ctx.fillRect(0,0,canvasW,canvasH); }
        layers.push({ canvas, ctx, name: name || `„É¨„Ç§„É§„Éº ${layers.length+1}` });
        wrapper.insertBefore(canvas, inter);
        curIdx = layers.length - 1;
        renderLayerList();
    }

    function deleteLayer(idx, e) {
        e.stopPropagation();
        if(layers.length <= 1) return;
        wrapper.removeChild(layers[idx].canvas);
        layers.splice(idx, 1);
        curIdx = Math.max(0, idx - 1);
        renderLayerList();
        saveState();
    }

    function moveLayer(idx, dir, e) {
        e.stopPropagation();
        const target = idx + dir;
        if(target < 0 || target >= layers.length) return;
        [layers[idx], layers[target]] = [layers[target], layers[idx]];
        layers.forEach(l => wrapper.appendChild(l.canvas));
        wrapper.appendChild(inter);
        curIdx = target;
        renderLayerList();
        saveState();
    }

    function renderLayerList() {
        const list = document.getElementById('layerList');
        list.innerHTML = '';
        layers.forEach((l, i) => {
            const d = document.createElement('div');
            d.className = `layer-item ${i === curIdx ? 'active' : ''}`;
            d.onclick = () => { curIdx = i; renderLayerList(); };
            d.innerHTML = `
                <span class="layer-name" onclick="renameLayer(${i}, event)">${l.name}</span>
                <button class="layer-btn" onclick="moveLayer(${i}, 1, event)">‚ñ≤</button>
                <button class="layer-btn" onclick="moveLayer(${i}, -1, event)">‚ñº</button>
                <button class="layer-btn" style="background:#822" onclick="deleteLayer(${i}, event)">üóëÔ∏è</button>
            `;
            list.prepend(d);
        });
    }

    function renameLayer(idx, e) {
        e.stopPropagation();
        const n = prompt("ÂêçÂâç„ÇíÂ§âÊõ¥:", layers[idx].name);
        if(n) { layers[idx].name = n; renderLayerList(); }
    }

    // --- ÁîªÂÉè„Ç§„É≥„Éù„Éº„Éà ---
    function handleImport(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                editImg = img;
                editState = { x: 100, y: 100, w: img.width*0.5, h: img.height*0.5, rot: 0 };
                document.getElementById('transform-ui').style.display = 'block';
                drawPreview();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function drawPreview() {
        if(!editImg) return;
        const ctx = inter.getContext('2d');
        ctx.clearRect(0,0,canvasW,canvasH);
        ctx.save();
        ctx.translate(editState.x + editState.w/2, editState.y + editState.h/2);
        ctx.rotate(editState.rot * Math.PI / 180);
        ctx.drawImage(editImg, -editState.w/2, -editState.h/2, editState.w, editState.h);
        ctx.restore();
    }

    function commitTransform() {
        addLayer("ÁîªÂÉè„É¨„Ç§„É§„Éº");
        const ctx = layers[curIdx].ctx;
        ctx.save();
        ctx.translate(editState.x + editState.w/2, editState.y + editState.h/2);
        ctx.rotate(editState.rot * Math.PI / 180);
        ctx.drawImage(editImg, -editState.w/2, -editState.h/2, editState.w, editState.h);
        ctx.restore();
        
        editImg = null;
        document.getElementById('transform-ui').style.display = 'none';
        inter.getContext('2d').clearRect(0,0,canvasW,canvasH);
        saveState();
    }

    // --- Âü∫Êú¨Ê©üËÉΩ ---
    function setTool(t) {
        currentTool = t;
        document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${t}`).classList.add('active');
    }

    function togglePanel() { document.getElementById('side-panel').classList.toggle('open'); }

    function floodFill(startX, startY) {
        const ctx = layers[curIdx].ctx;
        const id = ctx.getImageData(0,0,canvasW,canvasH);
        const d = id.data;
        const p = (startY * canvasW + startX) * 4;
        const tr = d[p], tg = d[p+1], tb = d[p+2], ta = d[p+3];
        const fc = document.getElementById('picker').value;
        const f = {r:parseInt(fc.slice(1,3),16), g:parseInt(fc.slice(3,5),16), b:parseInt(fc.slice(5,7),16)};
        if(tr===f.r && tg===f.g && tb===f.b && ta===255) return;
        const s = [[startX, startY]];
        while(s.length) {
            const [x,y] = s.pop();
            const curP = (y * canvasW + x) * 4;
            if(x>=0 && x<canvasW && y>=0 && y<canvasH && d[curP]===tr && d[curP+1]===tg && d[curP+2]===tb && d[curP+3]===ta) {
                d[curP]=f.r; d[curP+1]=f.g; d[curP+2]=f.b; d[curP+3]=255;
                s.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
            }
        }
        ctx.putImageData(id,0,0);
    }

    function saveState() {
        undoStack.push(layers.map(l => ({ img: l.canvas.toDataURL(), name: l.name })));
        if(undoStack.length > 30) undoStack.shift();
        redoStack = [];
    }

    function undo() {
        if(undoStack.length <= 1) return;
        redoStack.push(undoStack.pop());
        applyState(undoStack[undoStack.length-1]);
    }

    function redo() {
        if(!redoStack.length) return;
        const s = redoStack.pop();
        undoStack.push(s);
        applyState(s);
    }

    function applyState(state) {
        state.forEach((s, i) => {
            const img = new Image();
            img.onload = () => {
                layers[i].ctx.clearRect(0,0,canvasW,canvasH);
                layers[i].ctx.drawImage(img,0,0);
                layers[i].name = s.name;
                renderLayerList();
            };
            img.src = s.img;
        });
    }

    function saveImage() {
        const out = document.createElement('canvas'); out.width = canvasW; out.height = canvasH;
        const octx = out.getContext('2d');
        layers.forEach(l => octx.drawImage(l.canvas, 0, 0));
        const a = document.createElement('a'); a.download = 'art.png'; a.href = out.toDataURL(); a.click();
    }
</script>
</body>
</html>
