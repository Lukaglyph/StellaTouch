<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StellaTouch</title>
    <style>
        :root { --accent: #007bff; --bg: #121212; --panel: rgba(30, 30, 30, 0.98); --text: #ffffff; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: sans-serif; touch-action: none; user-select: none; }
        
        #viewport { position: fixed; inset: 0; overflow: hidden; background: #222; display: flex; align-items: center; justify-content: center; }
        #canvas-wrapper { position: relative; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); transform-origin: center; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #interaction-layer { pointer-events: auto !important; z-index: 100; cursor: crosshair; }

        /* ä¸‹éƒ¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        #bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: var(--panel); display: flex; align-items: center; justify-content: space-around; padding: 0 10px; z-index: 1000; border-top: 1px solid #333; }
        .m-btn { width: 55px; height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 20px; border-radius: 12px; border: none; background: transparent; color: white; cursor: pointer; }
        .m-btn.active { background: var(--accent); }
        .m-btn span { font-size: 9px; margin-top: 4px; }

        /* ä¸Šéƒ¨ãƒãƒ¼ */
        #top-bar { position: fixed; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .btn-group { display: flex; gap: 8px; pointer-events: auto; }
        .circle-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--panel); border: 1px solid #444; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ï¼‰ */
        #side-panel { position: fixed; top: 0; right: -320px; bottom: 75px; width: 300px; background: var(--panel); transition: 0.3s; z-index: 1001; padding: 15px; border-radius: 20px 0 0 20px; border-left: 1px solid #444; overflow-y: auto; }
        #side-panel.open { right: 0; }
        
        .layer-item { background: #2a2a2a; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 2px solid transparent; }
        .layer-item.active { border-color: var(--accent); background: #333; }
        .layer-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .layer-name { flex-grow: 1; font-size: 14px; cursor: text; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .layer-controls { display: flex; gap: 4px; }
        .l-btn { background: #444; border: none; color: white; padding: 5px; border-radius: 4px; font-size: 12px; cursor: pointer; width: 28px; }
        .l-btn:active { background: var(--accent); }
        
        .opacity-box { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #aaa; }
        .opacity-slider { flex-grow: 1; height: 4px; accent-color: var(--accent); }

        #setup-screen { position: fixed; inset: 0; background: #111; z-index: 3000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="setup-screen">
    <div style="background:#222; padding:30px; border-radius:20px; text-align:center;">
        <h2 style="color:var(--accent)">StellaTouch</h2>
        <input type="number" id="inputW" value="1000" style="width:70px; padding:8px;"> Ã— 
        <input type="number" id="inputH" value="1200" style="width:70px; padding:8px;">
        <br><br>
        <button onclick="initApp()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:bold;">ç™½ç´™ã‚’ä½œæˆ</button>
    </div>
</div>

<div id="viewport">
    <div id="canvas-wrapper">
        <canvas id="interaction-layer"></canvas>
    </div>
</div>

<div id="top-bar">
    <div class="btn-group">
        <button class="circle-btn" onclick="undo()">â†©ï¸</button>
        <button class="circle-btn" onclick="redo()">â†ªï¸</button>
    </div>
    <div class="btn-group">
        <button class="circle-btn" onclick="changeZoom(1.2)">ğŸ”+</button>
        <button class="circle-btn" onclick="changeZoom(0.8)">ğŸ”-</button>
        <button class="circle-btn" onclick="resetZoom()">å›</button>
        <button class="circle-btn" onclick="saveImage()">ğŸ’¾</button>
    </div>
</div>

<div id="bottom-bar">
    <button class="m-btn active" id="btn-brush" onclick="setTool('brush')">ğŸ–Œï¸<span>ãƒšãƒ³</span></button>
    <button class="m-btn" id="btn-eraser" onclick="setTool('eraser')">ğŸ§½<span>æ¶ˆã—</span></button>
    <button class="m-btn" id="btn-fill" onclick="setTool('fill')">ğŸ«—<span>å¡—ã‚‹</span></button>
    <button class="m-btn" id="btn-pan" onclick="setTool('pan')">âœ‹<span>ç§»å‹•</span></button>
    <button class="m-btn" onclick="togglePanel()">ğŸ“‚<span>å±¤</span></button>
</div>

<div id="side-panel">
    <h3>ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†</h3>
    <div id="layerList"></div>
    <button onclick="addLayer()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">+ æ–°è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼</button>
    
    <hr style="margin:20px 0; border:0; border-top:1px solid #444;">
    <div style="font-size:12px; margin-bottom:5px;">ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚º / è‰²</div>
    <input type="range" id="size" min="1" max="200" value="20" style="width:100%; margin-bottom:10px;">
    <input type="color" id="picker" value="#007bff" style="width:100%; height:44px; border:none; background:none;">
    <br><br>
    <button onclick="togglePanel()" style="width:100%; padding:10px; background:#444; border:none; color:white; border-radius:8px;">é–‰ã˜ã‚‹</button>
</div>

<script>
    let layers = [], curIdx = -1, canvasW, canvasH;
    let scale = 1, offsetX = 0, offsetY = 0;
    let drawing = false, panning = false, currentTool = 'brush';
    let lastX, lastY, undoStack = [], redoStack = [];

    const wrapper = document.getElementById('canvas-wrapper');
    const inter = document.getElementById('interaction-layer');

    function initApp() {
        canvasW = parseInt(document.getElementById('inputW').value) || 1000;
        canvasH = parseInt(document.getElementById('inputH').value) || 1200;
        document.getElementById('setup-screen').style.display = 'none';
        wrapper.style.width = canvasW + 'px'; wrapper.style.height = canvasH + 'px';
        inter.width = canvasW; inter.height = canvasH;
        addLayer("èƒŒæ™¯", true);
        addLayer("ãƒ¬ã‚¤ãƒ¤ãƒ¼ 1");
        resetZoom();
        setupEvents();
    }

    function setupEvents() {
        // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ºãƒ¼ãƒ 
        window.addEventListener('wheel', e => {
            if(e.ctrlKey || e.target.closest('#viewport')) {
                e.preventDefault();
                changeZoom(e.deltaY > 0 ? 0.9 : 1.1);
            }
        }, {passive: false});

        // å…±é€šãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆPC/ã‚¹ãƒãƒ›ï¼‰
        inter.addEventListener('pointerdown', e => {
            if(currentTool === 'pan' || e.button === 1) { panning = true; return; }
            drawing = true;
            const pos = getPos(e);
            if(currentTool === 'fill') { floodFill(Math.round(pos.x), Math.round(pos.y)); saveState(); drawing = false; }
            lastX = pos.x; lastY = pos.y;
            inter.setPointerCapture(e.pointerId);
        });

        window.addEventListener('pointermove', e => {
            if(panning) {
                offsetX += e.movementX; offsetY += e.movementY;
                updateTransform(); return;
            }
            if(!drawing || curIdx === -1) return;
            const pos = getPos(e);
            const ctx = layers[curIdx].ctx;
            ctx.save();
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.lineWidth = document.getElementById('size').value;
            ctx.strokeStyle = document.getElementById('picker').value;
            if(currentTool === 'eraser') ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke();
            ctx.restore();
            lastX = pos.x; lastY = pos.y;
        });

        window.addEventListener('pointerup', () => { if(drawing) saveState(); drawing = false; panning = false; });
    }

    function getPos(e) {
        const rect = wrapper.getBoundingClientRect();
        return { x: (e.clientX - rect.left) / scale, y: (e.clientY - rect.top) / scale };
    }

    // --- ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ ---
    function addLayer(name = null, white = false) {
        const canvas = document.createElement('canvas');
        canvas.width = canvasW; canvas.height = canvasH;
        const ctx = canvas.getContext('2d', {willReadFrequently: true});
        if(white) { ctx.fillStyle = "white"; ctx.fillRect(0,0,canvasW,canvasH); }
        layers.push({ canvas, ctx, name: name || `ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${layers.length+1}`, opacity: 1 });
        wrapper.insertBefore(canvas, inter);
        curIdx = layers.length - 1;
        renderLayerList();
    }

    function deleteLayer(idx, e) {
        e.stopPropagation();
        if(layers.length <= 1) return;
        wrapper.removeChild(layers[idx].canvas);
        layers.splice(idx, 1);
        curIdx = Math.max(0, idx - 1);
        renderLayerList();
        saveState();
    }

    function moveLayer(idx, dir, e) {
        e.stopPropagation();
        const target = idx + dir;
        if(target < 0 || target >= layers.length) return;
        [layers[idx], layers[target]] = [layers[target], layers[idx]];
        layers.forEach(l => wrapper.appendChild(l.canvas));
        wrapper.appendChild(inter);
        curIdx = target;
        renderLayerList();
    }

    function updateOpacity(idx, val) {
        layers[idx].opacity = val;
        layers[idx].canvas.style.opacity = val;
    }

    function renameLayer(idx, e) {
        e.stopPropagation();
        const n = prompt("ãƒ¬ã‚¤ãƒ¤ãƒ¼åã®å¤‰æ›´:", layers[idx].name);
        if(n) { layers[idx].name = n; renderLayerList(); }
    }

    function renderLayerList() {
        const list = document.getElementById('layerList');
        list.innerHTML = '';
        layers.forEach((l, i) => {
            const d = document.createElement('div');
            d.className = `layer-item ${i === curIdx ? 'active' : ''}`;
            d.onclick = () => { curIdx = i; renderLayerList(); };
            d.innerHTML = `
                <div class="layer-row">
                    <span class="layer-name" onclick="renameLayer(${i}, event)">${l.name}</span>
                    <div class="layer-controls">
                        <button class="l-btn" onclick="moveLayer(${i}, 1, event)">â–²</button>
                        <button class="l-btn" onclick="moveLayer(${i}, -1, event)">â–¼</button>
                        <button class="l-btn" style="color:#ff4444" onclick="deleteLayer(${i}, event)">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="opacity-box">
                    <span>é€æ˜åº¦</span>
                    <input type="range" class="opacity-slider" min="0" max="1" step="0.01" value="${l.opacity}" 
                           oninput="updateOpacity(${i}, this.value)" onclick="event.stopPropagation()">
                </div>
            `;
            list.prepend(d);
        });
    }

    // --- è¡¨ç¤ºãƒ»å±¥æ­´ãƒ»ãƒ„ãƒ¼ãƒ« ---
    function updateTransform() { wrapper.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`; }
    function changeZoom(f) { scale = Math.min(Math.max(scale * f, 0.1), 10); updateTransform(); }
    function resetZoom() {
        const v = document.getElementById('viewport');
        scale = Math.min(v.clientWidth / canvasW, v.clientHeight / canvasH) * 0.85;
        offsetX = 0; offsetY = 0; updateTransform();
    }

    function setTool(t) {
        currentTool = t;
        document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${t}`).classList.add('active');
    }

    function togglePanel() { document.getElementById('side-panel').classList.toggle('open'); }

    function saveState() {
        undoStack.push(layers.map(l => ({ img: l.canvas.toDataURL(), name: l.name, op: l.opacity })));
        if(undoStack.length > 30) undoStack.shift();
        redoStack = [];
    }

    function undo() {
        if(undoStack.length <= 1) return;
        redoStack.push(undoStack.pop());
        const s = undoStack[undoStack.length - 1];
        s.forEach((data, i) => {
            const img = new Image();
            img.onload = () => {
                layers[i].ctx.clearRect(0,0,canvasW,canvasH);
                layers[i].ctx.drawImage(img,0,0);
                layers[i].name = data.name;
                updateOpacity(i, data.op);
                renderLayerList();
            };
            img.src = data.img;
        });
    }

    function floodFill(startX, startY) {
        const ctx = layers[curIdx].ctx;
        const id = ctx.getImageData(0,0,canvasW,canvasH);
        const d = id.data;
        const p = (startY * canvasW + startX) * 4;
        const tr = d[p], tg = d[p+1], tb = d[p+2], ta = d[p+3];
        const fc = document.getElementById('picker').value;
        const f = {r:parseInt(fc.slice(1,3),16), g:parseInt(fc.slice(3,5),16), b:parseInt(fc.slice(5,7),16)};
        if(tr===f.r && tg===f.g && tb===f.b && ta===255) return;
        const s = [[startX, startY]];
        while(s.length) {
            const [x,y] = s.pop();
            const curP = (y * canvasW + x) * 4;
            if(x>=0 && x<canvasW && y>=0 && y<canvasH && d[curP]===tr && d[curP+1]===tg && d[curP+2]===tb && d[curP+3]===ta) {
                d[curP]=f.r; d[curP+1]=f.g; d[curP+2]=f.b; d[curP+3]=255;
                s.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
            }
        }
        ctx.putImageData(id,0,0);
    }

    function saveImage() {
        const out = document.createElement('canvas'); out.width = canvasW; out.height = canvasH;
        const octx = out.getContext('2d');
        layers.forEach(l => { octx.globalAlpha = l.opacity; octx.drawImage(l.canvas, 0, 0); });
        const a = document.createElement('a'); a.download = 'art.png'; a.href = out.toDataURL(); a.click();
    }
</script>
</body>
</html>
